/**
 * ============================================================
 *  AUTOMATED PENETRATION TEST SUITE
 *  Target: http://localhost:3000
 *  Date: 2026-02-11
 * ============================================================
 */

const axios = require("axios");

const BASE = "http://localhost:3000";
const results = [];
let testNum = 0;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(id, category, name, severity, passed, details) {
    const icon = passed ? "âœ… PASS" : "âŒ FAIL";
    const sev = { CRITICAL: "ğŸ”´", HIGH: "ğŸŸ ", MEDIUM: "ğŸŸ¡", LOW: "ğŸ”µ" }[severity] || "";
    console.log(`  [${id}] ${sev} ${icon} | ${name}`);
    if (details) console.log(`       â†³ ${details}`);
    results.push({ id, category, name, severity, passed, details });
}

async function req(method, path, data, headers = {}) {
    try {
        const res = await axios({
            method,
            url: `${BASE}${path}`,
            data,
            headers: { "Content-Type": "application/json", ...headers },
            validateStatus: () => true,
            timeout: 10000,
        });
        return res;
    } catch (e) {
        return { status: 0, data: {}, headers: {}, error: e.message };
    }
}

// â”€â”€ Test Categories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function testHealthCheck() {
    console.log("\nâ”â”â” 0. HEALTH CHECK â”â”â”");
    const res = await req("GET", "/api/health");
    log(++testNum, "HEALTH", "Server reachable", "LOW", res.status === 200,
        `Status: ${res.status}, Body: ${JSON.stringify(res.data)}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. OPEN ADMIN REGISTRATION (CRITICAL)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testOpenAdminRegistration() {
    console.log("\nâ”â”â” 1. OPEN ADMIN REGISTRATION â”â”â”");

    const email = `pentest_admin_${Date.now()}@evil.com`;
    const res = await req("POST", "/api/v1/admin/register", {
        fullName: "Pentest Hacker",
        email,
        password: "hacked123",
    });

    const isVuln = res.status === 201;
    log(++testNum, "AUTH", "Open admin registration (no auth required)", "CRITICAL",
        !isVuln,
        isVuln
            ? `VULNERABLE! Created admin: ${email} â€” Status ${res.status}`
            : `Protected â€” Status ${res.status}`);

    // If admin was created, try to login as admin
    if (isVuln) {
        const loginRes = await req("POST", "/api/v1/admin/login", {
            email,
            password: "hacked123",
        });
        log(++testNum, "AUTH", "Login as newly created admin", "CRITICAL",
            loginRes.status !== 200,
            loginRes.status === 200
                ? `VULNERABLE! Got admin token: ${loginRes.data?.data?.token?.substring(0, 30)}...`
                : `Login blocked â€” Status ${loginRes.status}`);
        return loginRes.data?.data?.token;
    }
    return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. SQL INJECTION TESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testSQLInjection() {
    console.log("\nâ”â”â” 2. SQL INJECTION â”â”â”");

    const sqliPayloads = [
        { name: "Classic OR 1=1", email: "' OR 1=1 --", password: "anything" },
        { name: "UNION SELECT", email: "' UNION SELECT * FROM user --", password: "x" },
        { name: "Stacked queries", email: "test@x.com'; DROP TABLE user; --", password: "x" },
        { name: "Boolean-based blind", email: "test' AND 1=1 --", password: "x" },
        { name: "Time-based blind", email: "test' AND SLEEP(2) --", password: "x" },
        { name: "Double encoding", email: "%27%20OR%201%3D1%20--", password: "x" },
    ];

    for (const payload of sqliPayloads) {
        const start = Date.now();
        const res = await req("POST", "/api/v1/users/login", {
            email: payload.email,
            password: payload.password,
        });
        const elapsed = Date.now() - start;

        const isVuln = res.status === 200 || (payload.name.includes("Time") && elapsed > 2000);
        log(++testNum, "SQLI", `Login: ${payload.name}`, "CRITICAL",
            !isVuln,
            `Status: ${res.status}, Time: ${elapsed}ms`);
    }

    // SQLi in search
    const searchPayloads = ["'; DROP TABLE product; --", "' UNION SELECT * FROM user --", "1' OR '1'='1"];
    for (const payload of searchPayloads) {
        const res = await req("GET", `/api/v1/search?q=${encodeURIComponent(payload)}`);
        log(++testNum, "SQLI", `Search: ${payload.substring(0, 30)}`, "CRITICAL",
            res.status !== 200 || !res.data?.data?.users,
            `Status: ${res.status}`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. XSS / INPUT INJECTION TESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testXSS() {
    console.log("\nâ”â”â” 3. XSS / INPUT INJECTION â”â”â”");

    const xssPayloads = [
        `<script>alert('xss')</script>`,
        `<img src=x onerror=alert('xss')>`,
        `"><svg/onload=alert('xss')>`,
        `javascript:alert(document.cookie)`,
        `{{constructor.constructor('return this')()}}`,
    ];

    // Test: Registration with XSS in fullName
    for (const payload of xssPayloads) {
        const res = await req("POST", "/api/v1/users/register", {
            fullName: payload,
            email: `xss_${Date.now()}_${Math.random().toString(36).substring(7)}@test.com`,
            password: "test123456",
        });

        const stored = res.data?.data?.user?.fullName;
        const isStored = stored && stored.includes("<script>") || stored?.includes("onerror") || stored?.includes("onload");
        log(++testNum, "XSS", `Register: ${payload.substring(0, 35)}...`, "MEDIUM",
            !isStored,
            isStored
                ? `STORED XSS! Name saved as: ${stored}`
                : `Status: ${res.status}, Stored: ${stored || "N/A"}`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. AUTHENTICATION BYPASS TESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testAuthBypass() {
    console.log("\nâ”â”â” 4. AUTHENTICATION BYPASS â”â”â”");

    // No token
    const res1 = await req("GET", "/api/v1/users/profile");
    log(++testNum, "AUTH", "Access profile without token", "HIGH",
        res1.status === 401,
        `Status: ${res1.status}`);

    // Invalid token
    const res2 = await req("GET", "/api/v1/users/profile", null, {
        Authorization: "Bearer invalidtokenhere123456",
    });
    log(++testNum, "AUTH", "Access profile with invalid token", "HIGH",
        res2.status === 401,
        `Status: ${res2.status}`);

    // Expired-style / malformed JWT
    const fakeJwt = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjEiLCJlbWFpbCI6ImFkbWluQHRlc3QuY29tIiwiaWF0IjoxNjAwMDAwMDAwLCJleHAiOjE2MDAwMDAwMDF9.invalidsignature";
    const res3 = await req("GET", "/api/v1/users/profile", null, {
        Authorization: `Bearer ${fakeJwt}`,
    });
    log(++testNum, "AUTH", "Access profile with forged JWT", "HIGH",
        res3.status === 401,
        `Status: ${res3.status}`);

    // Admin endpoints without auth
    const adminEndpoints = [
        { m: "GET", p: "/api/v1/admin/users" },
        { m: "GET", p: "/api/v1/admin/orders" },
        { m: "GET", p: "/api/v1/admin/products" },
        { m: "GET", p: "/api/v1/admin/coupons" },
        { m: "GET", p: "/api/v1/admin/reviews" },
    ];

    for (const ep of adminEndpoints) {
        const res = await req(ep.m, ep.p);
        log(++testNum, "AUTH", `Admin ${ep.p} without token`, "HIGH",
            res.status === 401 || res.status === 403,
            `Status: ${res.status}`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. CORS / SECURITY HEADERS TEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testSecurityHeaders() {
    console.log("\nâ”â”â” 5. SECURITY HEADERS & CORS â”â”â”");

    const res = await req("GET", "/api/health");
    const h = res.headers;

    const headers = {
        "x-content-type-options": "MEDIUM",
        "x-frame-options": "MEDIUM",
        "strict-transport-security": "MEDIUM",
        "x-xss-protection": "LOW",
        "content-security-policy": "MEDIUM",
        "x-powered-by": "LOW",
    };

    for (const [header, sev] of Object.entries(headers)) {
        if (header === "x-powered-by") {
            log(++testNum, "HEADERS", `${header} should be absent`, sev,
                !h[header],
                h[header] ? `EXPOSED: ${h[header]}` : "Not present âœ“");
        } else {
            log(++testNum, "HEADERS", `${header} should be present`, sev,
                !!h[header],
                h[header] ? `Value: ${h[header]}` : "MISSING!");
        }
    }

    // CORS wildcard test
    const corsRes = await axios({
        method: "GET",
        url: `${BASE}/api/health`,
        headers: { Origin: "https://evil-attacker-site.com" },
        validateStatus: () => true,
    });
    const acao = corsRes.headers["access-control-allow-origin"];
    log(++testNum, "CORS", "Wildcard CORS allows any origin", "CRITICAL",
        acao !== "*",
        `Access-Control-Allow-Origin: ${acao || "not set"}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6. BRUTE FORCE / RATE LIMITING TEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testRateLimiting() {
    console.log("\nâ”â”â” 6. BRUTE FORCE / RATE LIMITING â”â”â”");

    let successCount = 0;
    const total = 20;

    for (let i = 0; i < total; i++) {
        const res = await req("POST", "/api/v1/users/login", {
            email: "nonexistent@test.com",
            password: `wrongpassword${i}`,
        });
        if (res.status !== 429) successCount++;
    }

    log(++testNum, "RATE", `${total} rapid login attempts`, "CRITICAL",
        successCount < total,
        successCount === total
            ? `VULNERABLE! All ${total} requests went through â€” no rate limiting`
            : `${successCount}/${total} requests succeeded before being rate limited`);

    // Also test admin login brute force
    successCount = 0;
    for (let i = 0; i < 10; i++) {
        const res = await req("POST", "/api/v1/admin/login", {
            email: "admin@test.com",
            password: `wrong${i}`,
        });
        if (res.status !== 429) successCount++;
    }

    log(++testNum, "RATE", `10 rapid admin login attempts`, "CRITICAL",
        successCount < 10,
        successCount === 10
            ? "VULNERABLE! No rate limiting on admin login"
            : `${successCount}/10 before rate limit`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7. INFORMATION DISCLOSURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testInfoDisclosure() {
    console.log("\nâ”â”â” 7. INFORMATION DISCLOSURE â”â”â”");

    // Error with stack trace
    const res1 = await req("GET", "/api/v1/nonexistent-route");
    log(++testNum, "INFO", "404 response format", "LOW",
        !res1.data?.stack,
        res1.data?.stack ? `STACK TRACE LEAKED: ${res1.data.stack.substring(0, 80)}...` : "No stack trace");

    // Trigger server error to see stack
    const res2 = await req("POST", "/api/v1/users/login", {
        email: { "$gt": "" },  // NoSQL-style injection to trigger type error
        password: "test",
    });
    log(++testNum, "INFO", "Error response with malformed input", "MEDIUM",
        !res2.data?.stack,
        res2.data?.stack
            ? `STACK TRACE LEAKED: ${res2.data.stack.substring(0, 100)}...`
            : `Status: ${res2.status}, Message: ${res2.data?.message || "N/A"}`);

    // Check if swagger is exposed
    const res3 = await req("GET", "/api-docs");
    log(++testNum, "INFO", "Swagger UI exposure", "LOW",
        res3.status === 404,
        res3.status !== 404 ? `Swagger exposed at /api-docs â€” Status ${res3.status}` : "Not found");

    // Login enumeration: distinct error for nonexistent vs wrong password
    const res4 = await req("POST", "/api/v1/users/login", {
        email: "nonexistent_pentest_user@notreal.com",
        password: "wrongpassword",
    });
    const msg4 = res4.data?.message;
    log(++testNum, "INFO", "Login: generic error for nonexistent user", "LOW",
        msg4 === "Invalid email or password",
        `Message: "${msg4}"`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8. PATH TRAVERSAL ON STATIC FILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testPathTraversal() {
    console.log("\nâ”â”â” 8. PATH TRAVERSAL â”â”â”");

    const traversalPayloads = [
        "/uploads/../../.env",
        "/uploads/..%2F..%2F.env",
        "/uploads/%2e%2e/%2e%2e/.env",
        "/uploads/....//....//etc/passwd",
        "/uploads/products/../../../package.json",
    ];

    for (const path of traversalPayloads) {
        const res = await req("GET", path);
        const isVuln = res.status === 200 && (
            String(res.data).includes("DATABASE") ||
            String(res.data).includes("JWT_SECRET") ||
            String(res.data).includes("root:") ||
            String(res.data).includes('"name"')
        );
        log(++testNum, "TRAVERSAL", `GET ${path.substring(0, 40)}`, "CRITICAL",
            !isVuln,
            isVuln ? "VULNERABLE! Sensitive file exposed!" : `Status: ${res.status}`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9. MASS ASSIGNMENT / PRIVILEGE ESCALATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testMassAssignment() {
    console.log("\nâ”â”â” 9. MASS ASSIGNMENT / PRIV ESC â”â”â”");

    // Try to register a user with isAdmin=true
    const email = `massassign_${Date.now()}@test.com`;
    const res = await req("POST", "/api/v1/users/register", {
        fullName: "Mass Assignment Test",
        email,
        password: "test123456",
        isAdmin: true,
        isUserVerified: true,
        isActive: true,
    });

    // Check if the user got admin privileges
    if (res.status === 201 && res.data?.data?.token) {
        const profileRes = await req("GET", "/api/v1/users/profile", null, {
            Authorization: `Bearer ${res.data.data.token}`,
        });
        const isAdmin = profileRes.data?.data?.isAdmin;
        log(++testNum, "PRIV_ESC", "Register with isAdmin=true", "CRITICAL",
            !isAdmin,
            isAdmin
                ? "VULNERABLE! User registered with admin privileges!"
                : `isAdmin: ${isAdmin} â€” Extra fields were ignored âœ“`);
    } else {
        log(++testNum, "PRIV_ESC", "Register with isAdmin=true", "CRITICAL",
            true,
            `Registration returned status ${res.status}`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10. NOSQL / JSON INJECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testNoSQLInjection() {
    console.log("\nâ”â”â” 10. NOSQL / JSON INJECTION â”â”â”");

    const payloads = [
        { name: "$gt operator", body: { email: { "$gt": "" }, password: { "$gt": "" } } },
        { name: "$ne operator", body: { email: { "$ne": "" }, password: { "$ne": "" } } },
        { name: "$regex operator", body: { email: { "$regex": ".*" }, password: { "$regex": ".*" } } },
    ];

    for (const payload of payloads) {
        const res = await req("POST", "/api/v1/users/login", payload.body);
        log(++testNum, "NOSQL", `Login: ${payload.name}`, "HIGH",
            res.status !== 200,
            `Status: ${res.status}`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 11. LARGE PAYLOAD / DOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testDOS() {
    console.log("\nâ”â”â” 11. LARGE PAYLOAD / DOS â”â”â”");

    // Giant payload test
    const bigPayload = { data: "A".repeat(10 * 1024 * 1024) }; // 10MB
    const start = Date.now();
    const res = await req("POST", "/api/v1/users/register", bigPayload);
    const elapsed = Date.now() - start;

    log(++testNum, "DOS", "10MB JSON payload accepted", "HIGH",
        res.status === 413,
        res.status !== 413
            ? `VULNERABLE! Server accepted 10MB payload â€” Status: ${res.status}, Time: ${elapsed}ms`
            : `Properly rejected with 413 â€” Time: ${elapsed}ms`);

    // Deeply nested JSON
    let nested = { a: "x" };
    for (let i = 0; i < 100; i++) nested = { a: nested };
    const res2 = await req("POST", "/api/v1/users/login", nested);
    log(++testNum, "DOS", "100-level nested JSON", "MEDIUM",
        res2.status >= 400,
        `Status: ${res2.status}, Time: ${Date.now() - start}ms`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 12. IDOR (Insecure Direct Object Reference)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testIDOR() {
    console.log("\nâ”â”â” 12. IDOR TESTS â”â”â”");

    // Register two users and try to access each other's data
    const user1Email = `idor_user1_${Date.now()}@test.com`;
    const user2Email = `idor_user2_${Date.now()}@test.com`;

    const reg1 = await req("POST", "/api/v1/users/register", {
        fullName: "IDOR User 1",
        email: user1Email,
        password: "test123456",
    });

    const reg2 = await req("POST", "/api/v1/users/register", {
        fullName: "IDOR User 2",
        email: user2Email,
        password: "test123456",
    });

    if (reg1.status === 201 && reg2.status === 201) {
        const token1 = reg1.data?.data?.token;
        const user2Id = reg2.data?.data?.user?.id;

        // User 1 trying to access User 2's bank details via admin route
        const res = await req("GET", `/api/v1/admin/users/${user2Id}`, null, {
            Authorization: `Bearer ${token1}`,
        });

        log(++testNum, "IDOR", "Non-admin accessing other user's details via admin route", "HIGH",
            res.status === 403 || res.status === 401,
            `Status: ${res.status}`);
    } else {
        log(++testNum, "IDOR", "Could not create test users", "LOW", true, "Test skipped");
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 13. WEAK PASSWORD ACCEPTANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testWeakPasswords() {
    console.log("\nâ”â”â” 13. WEAK PASSWORD POLICY â”â”â”");

    const weakPasswords = [
        { pw: "123456", name: "Numeric only (123456)" },
        { pw: "aaaaaa", name: "Single char repeated (aaaaaa)" },
        { pw: "password", name: "Common word (password)" },
        { pw: "qwerty", name: "Keyboard walk (qwerty)" },
        { pw: "abcdef", name: "Sequential letters (abcdef)" },
    ];

    for (const { pw, name } of weakPasswords) {
        const res = await req("POST", "/api/v1/users/register", {
            fullName: "Weak PW Test",
            email: `weakpw_${Date.now()}_${Math.random().toString(36).substring(7)}@test.com`,
            password: pw,
        });
        log(++testNum, "PASSWD", `Weak password accepted: ${name}`, "MEDIUM",
            res.status !== 201,
            res.status === 201
                ? "VULNERABLE! Weak password was accepted"
                : `Rejected â€” Status: ${res.status}`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 14. JWT SECRET STRENGTH TEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testJWTSecretStrength() {
    console.log("\nâ”â”â” 14. JWT TOKEN ANALYSIS â”â”â”");

    const email = `jwt_test_${Date.now()}@test.com`;
    const res = await req("POST", "/api/v1/users/register", {
        fullName: "JWT Test User",
        email,
        password: "test123456",
    });

    if (res.status === 201 && res.data?.data?.token) {
        const token = res.data.data.token;
        const parts = token.split(".");

        log(++testNum, "JWT", "Token structure (3 parts)", "LOW",
            parts.length === 3,
            `Parts: ${parts.length}`);

        // Decode payload
        const payload = JSON.parse(Buffer.from(parts[1], "base64").toString());
        log(++testNum, "JWT", "Token contains user email (info exposure)", "LOW",
            !payload.email,
            payload.email
                ? `Email exposed in token: ${payload.email}`
                : "No email in token âœ“");

        // Check expiry
        const exp = payload.exp;
        const iat = payload.iat;
        if (exp && iat) {
            const lifetimeHours = (exp - iat) / 3600;
            log(++testNum, "JWT", `Token lifetime: ${lifetimeHours.toFixed(0)} hours`, "MEDIUM",
                lifetimeHours <= 24,
                lifetimeHours > 24
                    ? `LONG LIVED! Token valid for ${lifetimeHours.toFixed(0)} hours (${(lifetimeHours / 24).toFixed(1)} days)`
                    : `Reasonable: ${lifetimeHours.toFixed(0)} hours`);
        }

        // Try token with "none" algorithm attack
        const header = JSON.stringify({ alg: "none", typ: "JWT" });
        const noneToken = Buffer.from(header).toString("base64url") + "." + parts[1] + ".";
        const noneRes = await req("GET", "/api/v1/users/profile", null, {
            Authorization: `Bearer ${noneToken}`,
        });
        log(++testNum, "JWT", "Algorithm 'none' bypass attempt", "CRITICAL",
            noneRes.status === 401,
            `Status: ${noneRes.status}`);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function main() {
    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘         PENETRATION TEST SUITE â€” node-ecommerce-backend    â•‘");
    console.log("â•‘         Target: http://localhost:3000                       â•‘");
    console.log("â•‘         Date: 2026-02-11                                   â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    await testHealthCheck();
    await testOpenAdminRegistration();
    await testSQLInjection();
    await testXSS();
    await testAuthBypass();
    await testSecurityHeaders();
    await testRateLimiting();
    await testInfoDisclosure();
    await testPathTraversal();
    await testMassAssignment();
    await testNoSQLInjection();
    await testDOS();
    await testIDOR();
    await testWeakPasswords();
    await testJWTSecretStrength();

    // â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘                    RESULTS SUMMARY                         â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    const passed = results.filter((r) => r.passed).length;
    const failed = results.filter((r) => !r.passed).length;
    const total = results.length;

    console.log(`  Total Tests:  ${total}`);
    console.log(`  âœ… Passed:    ${passed}`);
    console.log(`  âŒ Failed:    ${failed}`);
    console.log(`  Score:        ${((passed / total) * 100).toFixed(1)}%\n`);

    const critFails = results.filter((r) => !r.passed && r.severity === "CRITICAL");
    const highFails = results.filter((r) => !r.passed && r.severity === "HIGH");
    const medFails = results.filter((r) => !r.passed && r.severity === "MEDIUM");
    const lowFails = results.filter((r) => !r.passed && r.severity === "LOW");

    if (critFails.length) {
        console.log(`  ğŸ”´ CRITICAL failures: ${critFails.length}`);
        critFails.forEach((r) => console.log(`     - ${r.name}: ${r.details}`));
    }
    if (highFails.length) {
        console.log(`  ğŸŸ  HIGH failures: ${highFails.length}`);
        highFails.forEach((r) => console.log(`     - ${r.name}: ${r.details}`));
    }
    if (medFails.length) {
        console.log(`  ğŸŸ¡ MEDIUM failures: ${medFails.length}`);
        medFails.forEach((r) => console.log(`     - ${r.name}: ${r.details}`));
    }
    if (lowFails.length) {
        console.log(`  ğŸ”µ LOW failures: ${lowFails.length}`);
        lowFails.forEach((r) => console.log(`     - ${r.name}: ${r.details}`));
    }

    console.log("\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    console.log(`  OVERALL SECURITY GRADE: ${critFails.length > 2 ? "F (CRITICAL)" :
            critFails.length > 0 ? "D (VULNERABLE)" :
                highFails.length > 2 ? "C (NEEDS WORK)" :
                    highFails.length > 0 ? "B (FAIR)" : "A (GOOD)"
        }`);
    console.log("  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

main().catch(console.error);
